var swig = require("swig")
var md = require("marked")
var io = require("node-fs")

var db = require("db")
var l  = require("logly")


function mk_page(base, path, data){
	md(data, {}, function(err, page){
		if(err) return console.log(err)
		tpl = swig.compileFile(base)
		io.mkdir(path, "777", true, function(err){
			if(err) return console.log(err)
			io.writeFile(path+"/index.html",tpl.render({"page":page}),function(err){
				if(err) return console.log(err)
			})
		})
	})
}

this.html = function html(req, res, next){
	var tpl_val = {}
	db.page.read(null, function(err, data){
		if(err) return res.render("500", {'err': err})
		tpl_val.page = data
		res.render("admin/page", tpl_val)
	})
}

this.create = function create(req, res, next){
	data = req.body
	mk_page(
			req.app.settings.views+"/base.html", 
			"/mnt/site/"+data.name,
		 	data.content)
	db.page.create(
		{"name":data.name,"content":data.content},
		function(err, data){ 
			if(err) return res.render("500", err)
			res.redirect("/admin/page") 
		}
	)
}
this.update = function update(req, res, next){
	data = req.body
	mk_page(
			req.app.settings.views+"/base.html", 
			"/mnt/site/"+data.name,
		 	data.content)
	db.page.update(
		JSON.parse(data.page).id,
		{"name":data.name,"content":data.content},
		function(err, data){
			if(err) return res.render("500", err)
			res.redirect("/admin/page?ok="+data.ok)
		}
	)
}
this.destroy = function destroy(req, res, next){
	data = req.body
	db.page.destroy(
		JSON.parse(data.page).id,
		JSON.parse(data.page).rev,
		function(err, data){
			if(err) return res.render("500", err)
			res.redirect("/admin/page?ok="+data.ok)
		}
	)
}

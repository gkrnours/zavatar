var swig = require("swig")
var qs = require("querystring")
var io = require("fs")

var db = require("db")
var l  = require("logly")


this.html = function html(req, res, next){
	var tpl_val = {}
	db.menu.read(null, function(err, data){
		if(err) return
		tpl_val.menu = data
		db.page.read(null, function(err, data){
			if(err) return
			tpl_val.page = data
			res.render("admin/menu", tpl_val)
		})
	})
}

this.create = function create(req, res, next){
	db.menu.create({"name":"", "pid":""}, function(){
		res.redirect("/admin/menu")
	})
}
this.update = function update(req, res, next){
	// Process data
	load = {pages:[]} 
	data = req.body
	console.log(data)
	todo = data.name.length
	for(i=0; i<todo; ++i){
		if(data.page[i] == "###") continue
		load.pages.push({name: data.name[i], pid: data.page[i]})
	}
	// Build the menu
	db.page.read(null, function(err, data){
		if(err) return
		path = req.app.settings.views
		pages = {}
		for(i=0,l=data.length; i<l; ++i){
			pages[data[i].key.id] = data[i].value
		}
		tpl = swig.compileFile(path+"/menu_tpl.html")
		io.writeFile(path+"/menu.html", tpl.render({menu:load.pages, pages:pages}))
	})
	// Save in database
	db.menu.update(load,
		function(err, data){
			if(err) return res.redirect("/admin/menu?oops")
			res.redirect("/admin/menu")
		}
	)
}
